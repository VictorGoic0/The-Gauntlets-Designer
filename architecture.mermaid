graph TB
    subgraph "Client Browser A"
        A1[React App]
        A2["AuthContext<br/>(Google user state)"]
        A3["CanvasContext<br/>(canvas state)"]
        A4["Canvas Component<br/>(5,000 x 5,000px)"]
        A5["Konva Stage/Layer<br/>(pan & zoom)"]
        A6[Shape Components]
        A7["useCursorTracking<br/>(100ms throttle)"]
        A8["useObjectSync<br/>(shared-canvas)"]
        A9["usePresence<br/>(onDisconnect)"]
        
        A1 --> A2
        A1 --> A3
        A2 --> A4
        A3 --> A4
        A4 --> A5
        A5 --> A6
        A4 --> A7
        A4 --> A8
        A4 --> A9
    end
    
    subgraph "Client Browser B"
        B1[React App]
        B2["AuthContext<br/>(Google user state)"]
        B3["CanvasContext<br/>(canvas state)"]
        B4["Canvas Component<br/>(5,000 x 5,000px)"]
        B5["Konva Stage/Layer<br/>(pan & zoom)"]
        B6[Shape Components]
        B7["useCursorTracking<br/>(100ms throttle)"]
        B8["useObjectSync<br/>(shared-canvas)"]
        B9["usePresence<br/>(onDisconnect)"]
        
        B1 --> B2
        B1 --> B3
        B2 --> B4
        B3 --> B4
        B4 --> B5
        B5 --> B6
        B4 --> B7
        B4 --> B8
        B4 --> B9
    end
    
    subgraph "Firebase Backend"
        F1["Firebase Auth<br/>(Google Sign-In Only)"]
        F2[Firestore Database]
        
        subgraph "Firestore Collections<br/>(Shared Canvas)"
            F3["projects/shared-canvas/objects<br/>(with server timestamps)"]
            F4["projects/shared-canvas/cursors<br/>(auto-deleted via onDisconnect)"]
            F5["projects/shared-canvas/presence<br/>(auto-cleaned via onDisconnect)"]
        end
        
        F2 --> F3
        F2 --> F4
        F2 --> F5
    end
    
    subgraph "Real-Time Data Flow"
        direction LR
        R1["onSnapshot Listeners"]
        R2["Write Operations<br/>(with server timestamps)"]
        R3["Optimistic Updates<br/>(incl. deletion priority)"]
        R4["10 Color Palette<br/>(random assignment)"]
    end
    
    A2 -->|Google Sign-In| F1
    B2 -->|Google Sign-In| F1
    
    A7 -->|Write cursor every 100ms<br/>10 colors, interpolation<br/>Target: <50ms latency| F4
    B7 -->|Write cursor every 100ms<br/>10 colors, interpolation<br/>Target: <50ms latency| F4
    
    A8 -->|Write object changes<br/>Last-write-wins<br/>Optimistic deletion| F3
    B8 -->|Write object changes<br/>Last-write-wins<br/>Optimistic deletion| F3
    
    A9 -->|Write presence data<br/>onDisconnect cleanup| F5
    B9 -->|Write presence data<br/>onDisconnect cleanup| F5
    
    F4 -->|onSnapshot updates<br/>Cursor interpolation| A7
    F4 -->|onSnapshot updates<br/>Cursor interpolation| B7
    
    F3 -->|onSnapshot updates<br/>Server timestamps| A8
    F3 -->|onSnapshot updates<br/>Server timestamps| B8
    
    F5 -->|onSnapshot updates| A9
    F5 -->|onSnapshot updates| B9
    
    A8 -.->|Optimistic update<br/>Instant local| A6
    B8 -.->|Optimistic update<br/>Instant local| B6
    
    F3 -.->|Server reconciliation<br/>Timestamp-based| A8
    F3 -.->|Server reconciliation<br/>Timestamp-based| B8
    
    style F1 fill:#FFA500
    style F2 fill:#4285F4
    style F3 fill:#34A853
    style F4 fill:#34A853
    style F5 fill:#34A853
    style A1 fill:#61DAFB
    style B1 fill:#61DAFB